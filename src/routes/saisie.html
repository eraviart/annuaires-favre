<svelte:head>
  <title>Saisie | {config.title}</title>
</svelte:head>

<h1>Saisie</h1>

{#if lines !== null}
  <table>
    <thead>
      <tr>
        <th></th>
        <th>Utilisateur</th>
        <th>Année</th>
        <th>Page</th>
        <th>Département</th>
        <th>Localité</th>
        <th>Entreprise</th>
        <th>Temporaire</th>
        <th>Commentaire</th>
      </tr>
    </thead>
    <tbody>
      {#each lines as line}
        <tr class={line.id === lineId ? "bg-black text-white" : ""} on:click="toggleSelectLine(line)">
          <td><input checked={line.id === lineId} name="lineId" type="radio" value={line.id}></td>
          <td>{line.userName}</td>
          <td>{line.year}</td>
          <td>{line.page}</td>
          <td>{line.districtName}</td>
          <td>{line.cityName}</td>
          <td>{line.corporationName}</td>
          <td>{line.temporary ? "√" : ""}</td>
          <td>{line.comment || ""}</td>
        </tr>
      {/each}
    </tbody>
  </table>
{/if}

<form class="m-3" on:submit="submitForm(event)">
  <label for="year">Année</label>
  <input
    bind:value="year"
    class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
    id="year"
    type="number"
  >

  <label for="page">Page</label>
  <input
    bind:value="page"
    class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
    id="page"
    type="number"
  >

  <Autocomplete
    class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
    isAsync
    items="{districts}"
    name={districtName}
    on:input="autocompleteDistrict(event)"
    on:select="districtSelected(event)"
    placeholder="Premières lettres d'un département…"
  >
    <div class="notification">Chargement des départements…</div>
  </Autocomplete>
  <span
    class="border leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
  >{districtId || ""}</span>

  {#if districtId === null}
    <p class="bg-orange-dark border leading-tight px-3 py-2 rounded shadow text-white w-full">
      Un département est nécessaire au choix d'une localité.
    </p>
  {:else}
    <Autocomplete
      class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
      isAsync
      items="{cities}"
      name={cityName}
      on:input="autocompleteCity(event)"
      on:select="citySelected(event)"
      placeholder="Premières lettres d'une localité…"
    >
      <div class="notification">Chargement des localités…</div>
    </Autocomplete>
  {/if}
  <span
    class="border leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
  >{cityId || ""}</span>

  <Autocomplete
    class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
    isAsync
    items="{corporations}"
    name={corporationName}
    on:input="autocompleteCorporation(event)"
    on:select="corporationSelected(event)"
    placeholder="Premières lettres d'une entreprise…"
  >
    <div class="notification">Chargement des entreprises…</div>
  </Autocomplete>
  <span
    class="border leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
  >{corporationId || ""}</span>

  <label>
    <input bind:checked="temporary" type="checkbox">
    Bureau temporaire
  </label>

  <label for="comment">Comment</label>
  <textarea
    bind:value="comment"
    class="appearance-none border focus:outline-none focus:shadow-outline leading-tight px-3 py-2 rounded shadow text-grey-darker w-full"
    id="comment"
    rows="4"
  />

  <button type="submit">
    {#if lineId === null}
      Ajouter
    {:else}
      Modifier
    {/if}
  </button>
</form>

<script>
  import assert from "assert"
  import fetch from "cross-fetch"

  import config from "../config"

  export default {
    components: {
      Autocomplete: "../components/Autocomplete.html",
    },
    data() {
      return {
        cities: [],
        cityId: null,
        cityName: null,
        comment: "",
        corporationId: null,
        corporationName: null,
        corporations: [],
        districts: [],
        districtId: null,
        districtName: null,
        lineId: null,
        lines: null,
        page: 1,
        temporary: false,
        year: 1930,
      }
    },
    helpers: {
      config,
    },
    methods: {
      async autocompleteCity(term) {
        const { districtId, year } = this.get()
        const response = await fetch(
          `autocomplete_city?district=${districtId}&q=${encodeURIComponent(term)}&year=${year}`,
          {
          credentials: "same-origin",
          },
        )
        assert(response.ok)
        const cities = await response.json()
        this.set({ cities })
      },
      async autocompleteCorporation(term) {
        const response = await fetch(`autocomplete_corporation?q=${encodeURIComponent(term)}`, {
          credentials: "same-origin",
        })
        assert(response.ok)
        const corporations = await response.json()
        this.set({ corporations })
      },
      async autocompleteDistrict(term) {
        const { year } = this.get()
        const response = await fetch(`autocomplete_district?q=${encodeURIComponent(term)}&year=${year}`, {
          credentials: "same-origin",
        })
        assert(response.ok)
        const districts = await response.json()
        this.set({ districts })
      },
      citySelected(item) {
        this.set({ cityId: Number(item.id), cityName: item.name })
      },
      corporationSelected(item) {
        this.set({ corporationId: Number(item.id), corporationName: item.name })
      },
      districtSelected(item) {
        this.set({ districtId: Number(item.id), districtName: item.name })
      },
      async submitForm(event) {
        event.preventDefault()

        const {
          cityId,
          cityName,
          comment,
          corporationId,
          corporationName,
          districtId,
          districtName,
          lineId,
          page,
          temporary,
          year,
        } = this.get()
        const response = await fetch("upsert_line", {
          body: JSON.stringify({
            cityId,
            cityName,
            comment,
            corporationId,
            corporationName,
            districtId,
            districtName,
            lineId,
            page,
            temporary,
            year,
          }, null, 2),
          credentials: "same-origin",
          headers: {
            "Content-Type": "application/json; charset=utf-8",
          },
          method: "POST",
        })
        const result =
          response.ok || response.status === 400
            ? await response.json()
            : { error: { code: response.status, message: response.statusText } }
        if (result.error) {
          console.log(result.error.code, result.error.message)
        }
        this.set({ ...result })
      },
      toggleSelectLine(line) {
        const { lineId } = this.get()
        if (lineId === null) {
          this.set({
            cityId: line.cityId,
            cityName: line.cityName,
            comment: line.comment,
            corporationId: line.corporationId,
            corporationName: line.corporationName,
            districtId: line.districtId,
            districtName: line.districtName,
            lineId: line.id,
            page: line.page,
            temporary: line.temporary,
            year: line.year,
          })
        } else {
          this.set({
            comment: null,
            lineId: null,
            temporary: false,
          })
        }
      },
    },
    async oncreate() {
      const { page, year } = this.get()
      const response = await fetch(`lines?page=${page}&year=${year}`,
        {
          credentials: "same-origin",
        },
      )
      if (!response.ok) {
        return {
          lines: null,
        }
      }
      const lines = await response.json()
      this.set({ lines })
    },
    async preload(/* { params, query } */) {
      const { user } = this.store.get()
      // TODO: Handle when user doesn't exist.
      return {}
    },
  }
</script>
